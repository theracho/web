<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control de Inventario</title>
    <!-- Tailwind CSS para los estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librerías de React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel para transpilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://aistudiocdn.com/react@^19.2.0",
        "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
        "react/": "https://aistudiocdn.com/react@^19.2.0/"
      }
    }
    </script>
    
    <!-- FIREBASE SDKs (Compatibles con la versión React usada) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <script>
        // 2. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE
        // ESTAS SON TUS CREDENCIALES, YA NO NECESITAS EDITARLAS
        const firebaseConfig = {
            apiKey: "AIzaSyD2ISoRrqzzKwExfeSmy8gGqyhdZ318HpA",
            authDomain: "inventario-de-frutos-tostados.firebaseapp.com",
            projectId: "inventario-de-frutos-tostados",
            storageBucket: "inventario-de-frutos-tostados.firebasestorage.app",
            messagingSenderId: "662885478256",
            appId: "1:662885478256:web:5af2a2ce3d51d7f6c6e9b5",
            measurementId: "G-WT5X69GHTS"
        };

        // Inicializar Firebase y la Base de Datos Firestore
        const app = firebase.initializeApp(firebaseConfig);
        const db = app.firestore();
        
        // Hacemos que la variable 'db' esté disponible globalmente
        window.db = db;
        
        // Bloquear alert() en entorno de iFrame
        window.alert = function(message) {
            console.error("Alert bloqueada. Mensaje:", message);
        };
    </script>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // Extraer hooks de React para usarlos fácilmente
        const { useState, useEffect, useCallback } = React;

        // --- TIPOS Y CONSTANTES ---
        const MovementType = {
          Entrada: 'Entrada',
          Salida: 'Salida',
        };

        const INITIAL_PRODUCTS = [
            { code: 'SP000026', description: 'Almendra Tostada', total: 0 },
            { code: 'SP000025', description: 'Avellana Tostada', total: 0 },
            { code: 'SP000024', description: 'Maní Tostado Entero', total: 0 },
            { code: 'SP000078', description: 'Avellana Tostada Troceada', total: 0 },
            { code: 'SP000271', description: 'Maní Tostado Entero Engomado', total: 427 },
            { code: 'SP000272', description: 'Avellana Tostada Engomada', total: 470 },
            { code: 'SP000270', description: 'Almendra Tostada Engomada', total: 86 },
        ];

        // --- COMPONENTES DE REACT ---

        // Componente: Formulario de Transacciones
        const TransactionForm = ({ products, onAddTransaction, error, loading }) => {
          const [productCode, setProductCode] = useState(products[0]?.code || '');
          const [movementType, setMovementType] = useState(MovementType.Entrada);
          const [quantity, setQuantity] = useState('');

          useEffect(() => {
            if (!productCode && products.length > 0) {
              setProductCode(products[0].code);
            }
          }, [products, productCode]);

          const handleSubmit = (e) => {
            e.preventDefault();
            const numQuantity = parseInt(quantity, 10);
            if (!productCode || isNaN(numQuantity) || numQuantity <= 0) {
              return;
            }
            onAddTransaction(productCode, movementType, numQuantity);
            setQuantity('');
          };

          return (
            <div className="bg-white p-6 rounded-xl shadow-md">
              <h2 className="text-2xl font-bold text-gray-800 mb-6">Registrar Movimiento</h2>
              <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                {/* Product Code Select */}
                <div className="flex flex-col">
                  <label htmlFor="product-code" className="mb-2 font-semibold text-gray-600">Código de Producto</label>
                  <select
                    id="product-code"
                    value={productCode}
                    onChange={(e) => setProductCode(e.target.value)}
                    className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    disabled={loading}
                  >
                    {products.map((p) => (
                      <option key={p.code} value={p.code}>
                        {p.code} - {p.description}
                      </option>
                    ))}
                  </select>
                </div>
                {/* Movement Type Select */}
                <div className="flex flex-col">
                  <label htmlFor="movement-type" className="mb-2 font-semibold text-gray-600">Tipo de Movimiento</label>
                  <select
                    id="movement-type"
                    value={movementType}
                    onChange={(e) => setMovementType(e.target.value)}
                    className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    disabled={loading}
                  >
                    <option value={MovementType.Entrada}>Entrada</option>
                    <option value={MovementType.Salida}>Salida</option>
                  </select>
                </div>
                {/* Quantity Input */}
                <div className="flex flex-col">
                  <label htmlFor="quantity" className="mb-2 font-semibold text-gray-600">Cantidad</label>
                  <input
                    id="quantity"
                    type="number"
                    value={quantity}
                    onChange={(e) => setQuantity(e.target.value)}
                    placeholder="Ej: 50"
                    min="1"
                    className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                    disabled={loading}
                  />
                </div>
                {/* Submit Button */}
                <button
                  type="submit"
                  className={`w-full font-bold p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 transition duration-300 ease-in-out ${loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500'}`}
                  disabled={loading}
                >
                  {loading ? 'Procesando...' : 'Registrar'}
                </button>
              </form>
              {error && <p className="text-red-500 mt-4 text-center md:text-left">{error}</p>}
            </div>
          );
        };

        // Componente: Tabla de Inventario
        const InventoryTable = ({ products, loading }) => {
          return (
            <div className="bg-white p-6 rounded-xl shadow-md min-h-[200px]">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Inventario Principal</h2>
              {loading ? (
                  <div className="flex justify-center items-center h-full">
                      <p className="text-gray-500">Cargando inventario desde Firebase...</p>
                  </div>
              ) : (
                <div className="overflow-x-auto">
                  <table className="w-full text-left">
                    <thead className="bg-gray-50 border-b-2 border-gray-200">
                      <tr>
                        <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Código</th>
                        <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Descripción</th>
                        <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-right">Total (Stock)</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                      {products.map((product) => (
                        <tr key={product.code} className="hover:bg-gray-50">
                          <td className="p-4 whitespace-nowrap font-mono text-gray-700">{product.code}</td>
                          <td className="p-4 whitespace-nowrap text-gray-800">{product.description}</td>
                          <td className="p-4 whitespace-nowrap font-bold text-lg text-right text-gray-900">{product.total}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              )}
            </div>
          );
        };

        // Componente: Tabla de Historial
        const HistoryTable = ({ transactions }) => {
          return (
            <div className="bg-white p-6 rounded-xl shadow-md">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Historial de Transacciones</h2>
              <div className="max-h-96 overflow-y-auto border rounded-lg">
                <table className="w-full text-left min-w-max">
                  <thead className="bg-gray-50 border-b-2 border-gray-200 sticky top-0">
                    <tr>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Código</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Descripción</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-right">Cantidad</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-right">Saldo Resultante</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {transactions.length > 0 ? (
                      transactions.map((tx, index) => (
                        <tr key={index} className="hover:bg-gray-50">
                          <td className="p-4 whitespace-nowrap text-gray-700">{tx.date}</td>
                          <td className="p-4 whitespace-nowrap font-mono text-gray-700">{tx.code}</td>
                          <td className="p-4 whitespace-nowrap text-gray-800">{tx.description}</td>
                          <td className="p-4 whitespace-nowrap">
                            <span className={`px-2 py-1 text-xs font-semibold rounded-full ${tx.type === MovementType.Entrada ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                              {tx.type}
                            </span>
                          </td>
                          <td className={`p-4 whitespace-nowrap font-semibold text-right ${tx.type === MovementType.Entrada ? 'text-green-600' : 'text-red-600'}`}>
                            {tx.type === MovementType.Entrada ? '+' : '-'}{tx.quantity}
                          </td>
                          <td className="p-4 whitespace-nowrap font-bold text-right text-gray-900">{tx.resultingBalance}</td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="6" className="p-4 text-center text-gray-500">No hay transacciones registradas.</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        // Componente Principal: App
        const App = () => {
          const [products, setProducts] = useState(INITIAL_PRODUCTS);
          const [history, setHistory] = useState([]);
          const [error, setError] = useState(null);
          const [loading, setLoading] = useState(true); // Nuevo estado de carga

          // --- FIREBASE: CARGAR DATOS AL INICIO ---
          useEffect(() => {
              const loadDataFromFirebase = async () => {
                  if (!window.db) {
                      setError("Error de inicialización de Firebase. Faltan credenciales.");
                      setLoading(false);
                      return;
                  }
                  
                  try {
                      // 1. Cargar Inventario (Stock)
                      const stockRef = window.db.collection("inventario_stock").doc("stock_actual");
                      const stockDoc = await stockRef.get();

                      if (stockDoc.exists && stockDoc.data().items) {
                          setProducts(stockDoc.data().items);
                      } else {
                          // Si es la primera vez, guarda el stock inicial en Firebase
                          await stockRef.set({ items: INITIAL_PRODUCTS, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                          setProducts(INITIAL_PRODUCTS);
                      }

                      // 2. Cargar Historial (Movimientos)
                      const historySnapshot = await window.db.collection("historial_movimientos")
                                                              .orderBy("timestamp", "desc") // Mostrar lo más nuevo arriba
                                                              .get();

                      const loadedHistory = historySnapshot.docs.map(doc => ({
                          ...doc.data(),
                          // Convertir el timestamp de Firebase a una cadena legible
                          date: doc.data().timestamp ? new Date(doc.data().timestamp.toDate()).toLocaleString('es-ES') : new Date().toLocaleString('es-ES'),
                      }));
                      setHistory(loadedHistory);
                      
                  } catch (e) {
                      console.error("Error al cargar datos de Firebase:", e);
                      // Informamos al usuario que revise las reglas de seguridad
                      setError("Error de Firebase: Permiso denegado. Revise las Reglas de Seguridad en su Consola de Firebase y publique 'match /{document=**} { allow read, write: if true; }'.");
                      setProducts(INITIAL_PRODUCTS); // Fallback al inicial
                  } finally {
                      setLoading(false);
                  }
              };
              
              loadDataFromFirebase();

          }, []); // Se ejecuta solo al montar

          // --- FIREBASE: GUARDAR DATOS ---
          const saveInventoryAndHistory = async (newProducts, newTransaction) => {
              if (!window.db) return;
              
              // 1. Guardar Inventario (Stock)
              try {
                  const stockRef = window.db.collection("inventario_stock").doc("stock_actual");
                  await stockRef.update({ 
                      items: newProducts,
                      updatedAt: firebase.firestore.FieldValue.serverTimestamp() 
                  });
              } catch (e) {
                  // Si falla la actualización (update), intentamos crear el documento (set) si no existe
                  if (e.code === 'not-found') {
                    const stockRef = window.db.collection("inventario_stock").doc("stock_actual");
                    await stockRef.set({ items: newProducts, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
                  } else {
                    console.error("Error al guardar stock:", e);
                    setError("Error al actualizar el stock en la base de datos. (Revise las Reglas de Seguridad)");
                  }
              }

              // 2. Guardar Registro de Movimiento en el Historial
              try {
                  await window.db.collection("historial_movimientos").add({
                      ...newTransaction,
                      timestamp: firebase.firestore.FieldValue.serverTimestamp(), // Usar el timestamp del servidor
                  });
              } catch (e) {
                  console.error("Error al guardar historial:", e);
                  setError("Error al guardar el historial en la base de datos. (Revise las Reglas de Seguridad)");
              }
          };

          const handleAddTransaction = useCallback(async (code, type, quantity) => {
            setError(null);
            
            // Si está cargando o no hay db, no procesar
            if (loading || !window.db) return;

            const productIndex = products.findIndex(p => p.code === code);
            if (productIndex === -1) {
              setError(`Producto con código ${code} no encontrado.`);
              return;
            }

            const updatedProducts = [...products];
            const product = { ...updatedProducts[productIndex] };
            let newTotal = product.total;

            if (type === MovementType.Entrada) {
              newTotal += quantity;
            } else { // Salida
              if (product.total < quantity) {
                setError(`No hay stock suficiente. Stock actual: ${product.total}.`);
                return;
              }
              newTotal -= quantity;
            }
            
            product.total = newTotal;
            updatedProducts[productIndex] = product;

            const newTransaction = {
              code: product.code,
              description: product.description,
              type,
              quantity,
              resultingBalance: newTotal,
            };

            // ACTUALIZA EL ESTADO LOCAL (INMEDIATO)
            setProducts(updatedProducts);
            setHistory(prevHistory => [{ 
                ...newTransaction, 
                // Usar fecha local para la vista inmediata, el servidor usará su propio timestamp
                date: new Date().toLocaleString('es-ES') 
            }, ...prevHistory]); 
            
            // GUARDAR DATOS EN FIREBASE (PERSISTENTE)
            await saveInventoryAndHistory(updatedProducts, newTransaction);
            

          }, [products, loading]); // Dependencia de products, loading

          const downloadCSV = () => {
            // Se eliminó alert() por cumplimiento de reglas
            if (history.length === 0) {
              console.log("No hay movimientos para generar un reporte.");
              return;
            }

            const headers = ["Fecha", "Código", "Descripción", "Tipo", "Cantidad", "Saldo Resultante"];
            const csvContent = [
              headers.join(','),
              ...history.map(tx => [
                `"${tx.date}"`,
                tx.code,
                `"${tx.description}"`,
                tx.type,
                tx.quantity,
                tx.resultingBalance
              ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            link.href = URL.createObjectURL(blob);
            link.download = "reporte_de_movimientos.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
          };

          return (
            <div className="container mx-auto p-4 md:p-8">
              <header className="mb-8 text-center">
                <h1 className="text-4xl md:text-5xl font-extrabold text-gray-800">
                  Control de Inventario
                </h1>
                <p className="text-lg text-gray-600 mt-2">Frutos Tostados y Engomados</p>
              </header>

              <main className="space-y-8">
                <TransactionForm products={products} onAddTransaction={handleAddTransaction} error={error} loading={loading}/>
                <InventoryTable products={products} loading={loading} />
                
                <div className="flex justify-center md:justify-end">
                    <button
                      onClick={downloadCSV}
                      className="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 ease-in-out flex items-center gap-2"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 10.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" />
                      </svg>
                      Descargar Reporte de Movimientos
                    </button>
                </div>

                <HistoryTable transactions={history} />
              </main>
              
              <footer className="text-center mt-12 text-gray-500">
                <p>&copy; {new Date().getFullYear()} Gestión de Inventario. Todos los derechos reservados.</p>
              </footer>
            </div>
          );
        };

        // --- INICIAR Y RENDERIZAR LA APLICACIÓN ---
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);

    </script>
</body>
</html>
