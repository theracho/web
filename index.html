<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Control de Inventario</title>
    <!-- Tailwind CSS para los estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librerías de React -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel para transpilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // Extraer hooks de React para usarlos fácilmente
        const { useState, useEffect, useCallback } = React;

        // --- TIPOS Y CONSTANTES ---
        const MovementType = {
          Entrada: 'Entrada',
          Salida: 'Salida',
        };

        const INITIAL_PRODUCTS = [
            { code: 'SP000026', description: 'Almendra Tostada', total: 0 },
            { code: 'SP000025', description: 'Avellana Tostada', total: 0 },
            { code: 'SP000024', description: 'Maní Tostado Entero', total: 0 },
            { code: 'SP000078', description: 'Avellana Tostada Troceada', total: 0 },
            { code: 'SP000271', description: 'Maní Tostado Entero Engomado', total: 427 },
            { code: 'SP000272', description: 'Avellana Tostada Engomada', total: 470 },
            { code: 'SP000270', description: 'Almendra Tostada Engomada', total: 86 },
        ];

        // --- COMPONENTES DE REACT ---

        // Componente: Formulario de Transacciones
        const TransactionForm = ({ products, onAddTransaction, error }) => {
          const [productCode, setProductCode] = useState(products[0]?.code || '');
          const [movementType, setMovementType] = useState(MovementType.Entrada);
          const [quantity, setQuantity] = useState('');

          useEffect(() => {
            if (!productCode && products.length > 0) {
              setProductCode(products[0].code);
            }
          }, [products, productCode]);

          const handleSubmit = (e) => {
            e.preventDefault();
            const numQuantity = parseInt(quantity, 10);
            if (!productCode || isNaN(numQuantity) || numQuantity <= 0) {
              return;
            }
            onAddTransaction(productCode, movementType, numQuantity);
            setQuantity('');
          };

          return (
            <div className="bg-white p-6 rounded-xl shadow-md">
              <h2 className="text-2xl font-bold text-gray-800 mb-6">Registrar Movimiento</h2>
              <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div className="flex flex-col">
                  <label htmlFor="product-code" className="mb-2 font-semibold text-gray-600">Código de Producto</label>
                  <select
                    id="product-code"
                    value={productCode}
                    onChange={(e) => setProductCode(e.target.value)}
                    className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  >
                    {products.map((p) => (
                      <option key={p.code} value={p.code}>
                        {p.code} - {p.description}
                      </option>
                    ))}
                  </select>
                </div>
                <div className="flex flex-col">
                  <label htmlFor="movement-type" className="mb-2 font-semibold text-gray-600">Tipo de Movimiento</label>
                  <select
                    id="movement-type"
                    value={movementType}
                    onChange={(e) => setMovementType(e.target.value)}
                    className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  >
                    <option value={MovementType.Entrada}>Entrada</option>
                    <option value={MovementType.Salida}>Salida</option>
                  </select>
                </div>
                <div className="flex flex-col">
                  <label htmlFor="quantity" className="mb-2 font-semibold text-gray-600">Cantidad</label>
                  <input
                    id="quantity"
                    type="number"
                    value={quantity}
                    onChange={(e) => setQuantity(e.target.value)}
                    placeholder="Ej: 50"
                    min="1"
                    className="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
                  />
                </div>
                <button
                  type="submit"
                  className="w-full bg-blue-600 text-white font-bold p-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out"
                >
                  Registrar
                </button>
              </form>
              {error && <p className="text-red-500 mt-4 text-center md:text-left">{error}</p>}
            </div>
          );
        };

        // Componente: Tabla de Inventario
        const InventoryTable = ({ products }) => {
          return (
            <div className="bg-white p-6 rounded-xl shadow-md">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Inventario Principal</h2>
              <div className="overflow-x-auto">
                <table className="w-full text-left">
                  <thead className="bg-gray-50 border-b-2 border-gray-200">
                    <tr>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Código</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Descripción</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-right">Total (Stock)</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {products.map((product) => (
                      <tr key={product.code} className="hover:bg-gray-50">
                        <td className="p-4 whitespace-nowrap font-mono text-gray-700">{product.code}</td>
                        <td className="p-4 whitespace-nowrap text-gray-800">{product.description}</td>
                        <td className="p-4 whitespace-nowrap font-bold text-lg text-right text-gray-900">{product.total}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        // Componente: Tabla de Historial
        const HistoryTable = ({ transactions }) => {
          return (
            <div className="bg-white p-6 rounded-xl shadow-md">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Historial de Transacciones</h2>
              <div className="max-h-96 overflow-y-auto border rounded-lg">
                <table className="w-full text-left min-w-max">
                  <thead className="bg-gray-50 border-b-2 border-gray-200 sticky top-0">
                    <tr>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Código</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Descripción</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-right">Cantidad</th>
                      <th className="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-right">Saldo Resultante</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {transactions.length > 0 ? (
                      transactions.map((tx, index) => (
                        <tr key={index} className="hover:bg-gray-50">
                          <td className="p-4 whitespace-nowrap text-gray-700">{tx.date}</td>
                          <td className="p-4 whitespace-nowrap font-mono text-gray-700">{tx.code}</td>
                          <td className="p-4 whitespace-nowrap text-gray-800">{tx.description}</td>
                          <td className="p-4 whitespace-nowrap">
                            <span className={`px-2 py-1 text-xs font-semibold rounded-full ${tx.type === MovementType.Entrada ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                              {tx.type}
                            </span>
                          </td>
                          <td className={`p-4 whitespace-nowrap font-semibold text-right ${tx.type === MovementType.Entrada ? 'text-green-600' : 'text-red-600'}`}>
                            {tx.type === MovementType.Entrada ? '+' : '-'}{tx.quantity}
                          </td>
                          <td className="p-4 whitespace-nowrap font-bold text-right text-gray-900">{tx.resultingBalance}</td>
                        </tr>
                      ))
                    ) : (
                      <tr>
                        <td colSpan="6" className="p-4 text-center text-gray-500">No hay transacciones registradas.</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>
          );
        };

        // Componente Principal: App
        const App = () => {
          const loadStateFromStorage = () => {
            try {
              const storedProducts = localStorage.getItem('inventory_products');
              const storedHistory = localStorage.getItem('inventory_history');

              const products = storedProducts ? JSON.parse(storedProducts) : INITIAL_PRODUCTS;
              const history = storedHistory ? JSON.parse(storedHistory) : [];

              if (!Array.isArray(products) || !Array.isArray(history)) {
                  return { products: INITIAL_PRODUCTS, history: [] };
              }
              return { products, history };

            } catch (e) {
              console.error("Fallo al cargar desde localStorage", e);
              return { products: INITIAL_PRODUCTS, history: [] };
            }
          };

          const [products, setProducts] = useState(() => loadStateFromStorage().products);
          const [history, setHistory] = useState(() => loadStateFromStorage().history);
          const [error, setError] = useState(null);

          useEffect(() => {
            try {
              localStorage.setItem('inventory_products', JSON.stringify(products));
              localStorage.setItem('inventory_history', JSON.stringify(history));
            } catch (e) {
              console.error("Fallo al guardar en localStorage", e);
            }
          }, [products, history]);
          
          const handleAddTransaction = useCallback((code, type, quantity) => {
            setError(null);
            const productIndex = products.findIndex(p => p.code === code);
            if (productIndex === -1) {
              setError(`Producto con código ${code} no encontrado.`);
              return;
            }

            const updatedProducts = [...products];
            const product = { ...updatedProducts[productIndex] };
            let newTotal = product.total;

            if (type === MovementType.Entrada) {
              newTotal += quantity;
            } else { // Salida
              if (product.total < quantity) {
                setError(`No hay stock suficiente. Stock actual: ${product.total}.`);
                return;
              }
              newTotal -= quantity;
            }
            
            product.total = newTotal;
            updatedProducts[productIndex] = product;

            const newTransaction = {
              date: new Date().toLocaleString('es-ES'),
              code: product.code,
              description: product.description,
              type,
              quantity,
              resultingBalance: newTotal,
            };

            setProducts(updatedProducts);
            setHistory(prevHistory => [newTransaction, ...prevHistory]);

          }, [products]);

          const downloadCSV = () => {
            if (history.length === 0) {
              alert("No hay movimientos para generar un reporte.");
              return;
            }

            const headers = ["Fecha", "Código", "Descripción", "Tipo", "Cantidad", "Saldo Resultante"];
            const csvContent = [
              headers.join(','),
              ...history.map(tx => [
                `"${tx.date}"`,
                tx.code,
                `"${tx.description}"`,
                tx.type,
                tx.quantity,
                tx.resultingBalance
              ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            link.href = URL.createObjectURL(blob);
            link.download = "reporte_de_movimientos.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
          };

          return (
            <div className="container mx-auto p-4 md:p-8">
              <header className="mb-8 text-center">
                <h1 className="text-4xl md:text-5xl font-extrabold text-gray-800">
                  Control de Inventario
                </h1>
                <p className="text-lg text-gray-600 mt-2">Frutos Tostados y Engomados</p>
              </header>

              <main className="space-y-8">
                <TransactionForm products={products} onAddTransaction={handleAddTransaction} error={error}/>
                <InventoryTable products={products} />
                
                <div className="flex justify-center md:justify-end">
                    <button
                      onClick={downloadCSV}
                      className="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 ease-in-out flex items-center gap-2"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v4a1 1 0 102 0V7zM9 9a1 1 0 000 2h2a1 1 0 100-2H9z" clipRule="evenodd" />
                        <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 10.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" />
                      </svg>
                      Descargar Reporte de Movimientos
                    </button>
                </div>

                <HistoryTable transactions={history} />
              </main>
              
              <footer className="text-center mt-12 text-gray-500">
                <p>&copy; {new Date().getFullYear()} Gestión de Inventario. Todos los derechos reservados.</p>
              </footer>
            </div>
          );
        };

        // --- INICIAR Y RENDERIZAR LA APLICACIÓN ---
        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>
